# =============================
# FRONTEND (index.html)
# =============================
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Proxy Registration</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      width: 350px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .note {
      font-size: 0.9em;
      color: #555;
      margin-top: 10px;
    }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Proxy Access Request</h2>
    <input type="email" id="email" placeholder="student@student.isf.edu.hk" />
    <button onclick="submitForm()">Request Access</button>
    <p id="msg"></p>
    <p class="note">
      No software download required. Proxy can be configured directly in System Settings once approved.
    </p>
  </div>

<script>
function submitForm() {
  const email = document.getElementById('email').value;
  const msg = document.getElementById('msg');

  if (!email.endsWith('@student.isf.edu.hk')) {
    msg.textContent = 'Email must end with student.isf.edu.hk';
    msg.className = 'error';
    return;
  }

  fetch('https://YOUR_PYTHONANYWHERE_DOMAIN/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email })
  })
  .then(res => res.json())
  .then(data => {
    msg.textContent = data.message;
    msg.className = 'success';
  })
  .catch(() => {
    msg.textContent = 'Server error';
    msg.className = 'error';
  });
}
</script>
</body>
</html>


# =============================
# BACKEND (Flask - app.py)
# =============================
from flask import Flask, request, jsonify, render_template_string
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///requests.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

class Request(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(120), unique=True, nullable=False)
    approved = db.Column(db.Boolean, default=False)
    username = db.Column(db.String(80))
    password = db.Column(db.String(80))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

@app.before_first_request
def create_tables():
    db.create_all()

@app.route('/register', methods=['POST'])
def register():
    data = request.get_json()
    email = data.get('email', '')

    if not email.endswith('@student.isf.edu.hk'):
        return jsonify({'message': 'Invalid email domain'}), 400

    if Request.query.filter_by(email=email).first():
        return jsonify({'message': 'Request already submitted'})

    req = Request(email=email)
    db.session.add(req)
    db.session.commit()

    return jsonify({'message': 'Request submitted. Await approval.'})

# =============================
# ADMIN PANEL (simple, password-protect via PythonAnywhere)
# =============================
@app.route('/admin', methods=['GET', 'POST'])
def admin():
    if request.method == 'POST':
        req_id = request.form['id']
        username = request.form['username']
        password = request.form['password']

        req = Request.query.get(req_id)
        req.approved = True
        req.username = username
        req.password = password
        db.session.commit()

    requests = Request.query.all()

    return render_template_string('''
    <h2>Proxy Access Control Panel</h2>
    {% for r in requests %}
      <div style="border:1px solid #ccc;padding:10px;margin:10px;">
        <b>{{ r.email }}</b><br>
        Approved: {{ r.approved }}<br>
        {% if not r.approved %}
        <form method="post">
          <input type="hidden" name="id" value="{{ r.id }}" />
          <input name="username" placeholder="Proxy Username" required />
          <input name="password" placeholder="Proxy Password" required />
          <button type="submit">Approve</button>
        </form>
        {% else %}
        Username: {{ r.username }}<br>
        Password: {{ r.password }}
        {% endif %}
      </div>
    {% endfor %}
    ''', requests=requests)

if __name__ == '__main__':
    app.run()
